apiVersion: v1
kind: ConfigMap
metadata:
  name: kernel-pod-template
  namespace: enterprise-gateway
data:
  kernel-pod.yaml.j2: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: "{{ kernel_pod_name }}"
      namespace: "{{ kernel_namespace }}"
      labels:
        kernel_id: "{{ kernel_id }}"
        app: enterprise-gateway
        component: kernel
        source: kernel-pod.yaml
        kai.scheduler/queue: "{{ kernel_namespace }}-queue"
      annotations:
        sidecar.istio.io/inject: "false"
        gpu-memory: "{{ kernel_gpu_memory }}"
        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    spec:
      runtimeClassName: nvidia-cdi
      schedulerName: kai-scheduler
      nodeSelector:
        gpu-type: "{{ kernel_gpu_type }}"
      restartPolicy: Never
      serviceAccountName: "{{ kernel_service_account_name }}"
      {% if kernel_uid is defined or kernel_gid is defined %}
      securityContext:
        {% if kernel_uid is defined %}
        runAsUser: {{ kernel_uid | int }}
        {% endif %}
        {% if kernel_gid is defined %}
        runAsGroup: {{ kernel_gid | int }}
        {% endif %}
        fsGroup: 100
      {% endif %}

      # 1. SHARED VOLUME (EmptyDir)
      volumes:
      - name: custom-startup-scripts
        emptyDir: {}
      {% if kernel_volumes %}
        {% for volume in kernel_volumes %}
      - {{ volume }}
        {% endfor %}
      {% endif %}

      # 2. INIT CONTAINER (Download Script)
      initContainers:
      - name: download-gpu-enforcer
        image: "{{ kernel_image }}"
        command: ["python", "-c"]
        args:
          - |
            import urllib.request
            import os
            import ssl

            # Allow downloading from https without strict cert checking if needed inside cluster
            ctx = ssl.create_default_context()
            ctx.check_hostname = False
            ctx.verify_mode = ssl.CERT_NONE

            url = "https://raw.githubusercontent.com/lehuannhatrang/ml-platform-manifests/refs/heads/main/applications/enterprise-gateway/overlays/scripts/gpu-enforce-limit.py"
            dest_dir = "/opt/custom_kernels/ipython_config/profile_default/startup"
            dest_file = os.path.join(dest_dir, "00-enforce-limits.py")

            os.makedirs(dest_dir, exist_ok=True)
            
            with urllib.request.urlopen(url, context=ctx) as response, open(dest_file, 'wb') as out_file:
                out_file.write(response.read())
            
            print(f"Saved to {dest_file}")
            
            # Ensure permissions
            os.chmod(dest_file, 0o755)
        volumeMounts:
        - name: custom-startup-scripts
          mountPath: /opt/custom_kernels

      # 3. MAIN CONTAINER
      containers:
      - image: "{{ kernel_image }}"
        name: "{{ kernel_pod_name }}"
        env: []
        {% if kernel_cpus is defined or kernel_memory is defined or kernel_gpus is defined %}
        resources:
          requests:
            {% if kernel_cpus is defined %}
            cpu: "{{ kernel_cpus }}"
            {% endif %}
            {% if kernel_memory is defined %}
            memory: "{{ kernel_memory }}"
            {% endif %}
        {% endif %}
        {% if kernel_working_dir %}
        workingDir: "{{ kernel_working_dir }}"
        {% endif %}
        
        # MOUNT THE SHARED VOLUME
        volumeMounts:
        - name: custom-startup-scripts
          mountPath: /opt/custom_kernels
        {% if kernel_volume_mounts %}
        {% for volume_mount in kernel_volume_mounts %}
        - {{ volume_mount }}
        {% endfor %}
        {% endif %}
